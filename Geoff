## Load packages and other functions
library(knitr)
library(RColorBrewer)
library(ggplot2)
library(plyr)
library(dplyr)
library(QDNAseq)
library(Biobase)
library(survival)
library(survcomp)
library(flexmix)
library(DOSE)
library(ppcor)
library(VariantAnnotation)
library(org.Hs.eg.db)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(rtracklayer)
library(ReactomePA)
library(Hmisc)
library(corrplot)
library(ggpubr)
library(NbClust)
library(kableExtra)

setwd("~/Desktop/CRUK/britroc-cnsignatures-bfb69cd72c50")
source("main_functions.R")
source("helper_functions.R")

setwd("~/Desktop/CRUK/britroc-cnsignatures-bfb69cd72c50/manuscript_Rmarkdown")
# Read in ploidy and purity estimates obtained from Battenberg plots.


## 1

deep_metrics <- read.csv("data/britroc_deepWGS_ploidy_purity_49.csv", header=T, as.is = T)
deep_metrics$purity <- deep_metrics$purity/100
deep_metrics <- deep_metrics %>%
  mutate(name= sub("[0-9]+_tumor_","",x=wgs_ID)) %>%
  dplyr::select(name,ploidy, purity) %>%
  tidyr::gather("metric", "deep", -name)

# Get ploidy for sWGS samples

CN <- readRDS("data/britroc_absolute_copynumber.rds")
Biobase::pData(CN)$ploidy <- getPloidy(CN) %>%
  .$out

shallow_metrics <- Biobase::pData(CN) %>%
  dplyr::select(name, ploidy, purity) %>%
  filter(name %in% deep_metrics$name) %>%
  tidyr::gather("metric", "shallow", -name)


# Annotate sWGS samples with star_rating
samp_annotation_all <- read.csv("data/britroc_sample_data.csv", as.is=T)
samp_annot <- samp_annotation_all %>% 
  filter(IM.JBLAB_ID %in% shallow_metrics$name & Failed !="Y") %>%
  dplyr::select(IM.JBLAB_ID , star_rating)

# Combine estimates from deep and shallow WGS methods and retain 3-star samples
metrics <- inner_join(deep_metrics, shallow_metrics, by = c("name", "metric")) %>%
  inner_join(samp_annot,c("name" = "IM.JBLAB_ID" ) ) %>%
  filter(star_rating ==3)

# Perform correlation test of ploidy, purity in Britroc samples with dWGS and sWGS data
correlations <- metrics %>% 
  group_by(metric) %>%
  do(broom::tidy(cor.test(.$deep,.$shallow)))

## 2

# Create dataframes for annotation and generate plot for 3-star samples.

correlations$metric <- factor(correlations$metric, levels=c("ploidy", "purity"))

annot_text <- correlations %>% 
  ungroup() %>%
  dplyr::select(metric, estimate, p.value) %>%
  mutate(x=c(2,0.4),y.cor=c(4.5,0.9), y.pval= c(4.375, 0.87)) %>%
  group_by(metric) %>%
  mutate(label.cor=paste0("R^2== ",round(estimate,2)), label.pval = paste0("P== ", format(signif(p.value,1),digits=1, scientific = T)) )


cor_plot <- metrics %>%
  ggplot(aes(x=deep, y=shallow)) +
  geom_point()  + 
  geom_smooth(method = "lm") + 
  facet_wrap(~metric, scales = "free") +
  labs(x= "Deep WGS", y= "sWGS") +
  theme_bw()+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7),
        strip.text.x = element_text(size = 7), panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank())


cor_plot + 
  geom_text(data=annot_text, aes(label=label.cor, x=x,y=y.cor), parse = T,inherit.aes=FALSE, size=2) +
  geom_text(data=annot_text, aes(label=label.pval, x=x,y=y.pval), parse = T,inherit.aes=FALSE, size=2)


## 3
#read in absolute CN post ABCEL processing
all_CN<-readRDS("data/britroc_absolute_copynumber.rds")
all_CN<-all_CN[,colnames(all_CN)%in%samp_annotation[!samp_annotation$Failed=="Y","IM.JBLAB_ID"]]

#extract 3 star CN from each case
ids<-result %>% filter(star_rating==3)
ids<-ids$IM.JBLAB_ID
hq_CN<-all_CN[,colnames(all_CN)%in%ids]
ids<-result %>% filter(star_rating==2)
ids<-ids$IM.JBLAB_ID
lq_CN<-all_CN[,colnames(all_CN)%in%ids]

#estract copy-number features
CN_features<-extractCopynumberFeatures(hq_CN,cores=num_cores)
